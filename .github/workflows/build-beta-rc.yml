name: "Build Pipeline - plugin-smart-templates (Beta & RC)"

on:
  push:
    tags:
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'

permissions:
  id-token: write
  contents: read
  pull-requests: write
  packages: write

env:
  IS_BETA: ${{ contains(github.ref, '-beta') }}
  IS_RC:   ${{ contains(github.ref, '-rc') }}
  # Ajuste se o path de STAGE for diferente:
  GITOPS_FILE_DEV:  gitops/environments/firmino/helmfile/applications/dev/plugin-smart-templates/values.yaml
  GITOPS_FILE_STG:  gitops/environments/firmino/helmfile/applications/stg/plugin-smart-templates/values.yaml

jobs:
  detect_changes:
    runs-on: firmino-lxc-runners
    outputs:
      has_backend: ${{ steps.check.outputs.has_backend }}
      has_frontend: ${{ steps.check.outputs.has_frontend }}
      matrix: ${{ steps.changed.outputs.matrix }}
    steps:
      - name: Get changed paths
        id: changed
        uses: LerianStudio/github-actions-changed-paths@main
        with:
          filter_paths: |
            components/worker
            components/manager
            components/frontend
          get_app_name: true
          path_level: 2

      - name: Determine changed components
        id: check
        shell: bash
        run: |
          m='${{ steps.changed.outputs.matrix }}'
          if echo "$m" | grep -q '"manager"\|"worker"'; then
            echo "has_backend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_backend=false" >> "$GITHUB_OUTPUT"
          fi
          if echo "$m" | grep -q '"frontend"'; then
            echo "has_frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_frontend=false" >> "$GITHUB_OUTPUT"
          fi

  build_and_publish:
    needs: detect_changes
    if: needs.detect_changes.outputs.has_backend == 'true' || needs.detect_changes.outputs.has_frontend == 'true'
    runs-on: firmino-lxc-runners
    steps:
      - uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      # Manager
      - name: Build and publish manager to GHCR
        if: needs.detect_changes.outputs.has_backend == 'true'
        uses: LerianStudio/github-actions-ghcr-private-pipeline@main
        with:
          app_name: 'plugin-smart-templates-manager'
          context: .
          working_dir: components/manager
          token: ${{ secrets.MANAGE_TOKEN }}
          platforms: 'linux/amd64'

      - name: Build and publish manager to Docker Hub
        if: needs.detect_changes.outputs.has_backend == 'true'
        uses: LerianStudio/github-actions-docker-private-pipeline@main
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          docker_access_token: ${{ secrets.MANAGE_TOKEN }}
          app_name: 'plugin-smart-templates-manager'
          working_dir: components/manager
          platforms: 'linux/amd64'

      # Worker
      - name: Build and publish worker to GHCR
        if: needs.detect_changes.outputs.has_backend == 'true'
        uses: LerianStudio/github-actions-ghcr-private-pipeline@main
        with:
          app_name: 'plugin-smart-templates-worker'
          context: .
          working_dir: components/worker
          token: ${{ secrets.MANAGE_TOKEN }}
          platforms: 'linux/amd64'

      - name: Build and publish worker to Docker Hub
        if: needs.detect_changes.outputs.has_backend == 'true'
        uses: LerianStudio/github-actions-docker-private-pipeline@main
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          docker_access_token: ${{ secrets.MANAGE_TOKEN }}
          app_name: 'plugin-smart-templates-worker'
          working_dir: components/worker
          platforms: 'linux/amd64'

      # Frontend
      - name: Build and publish frontend to GHCR
        if: needs.detect_changes.outputs.has_frontend == 'true'
        uses: LerianStudio/github-actions-ghcr-private-pipeline@main
        with:
          app_name: 'plugin-smart-templates-frontend'
          context: .
          working_dir: components/frontend
          token: ${{ secrets.MANAGE_TOKEN }}
          platforms: 'linux/amd64'

      - name: Build and publish frontend to Docker Hub
        if: needs.detect_changes.outputs.has_frontend == 'true'
        uses: LerianStudio/github-actions-docker-private-pipeline@main
        with:
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          docker_access_token: ${{ secrets.MANAGE_TOKEN }}
          app_name: 'plugin-smart-templates-frontend'
          context: .
          working_dir: components/frontend
          platforms: 'linux/amd64'

      - name: Write GitOps tags
        shell: bash
        run: |
          mkdir -p gitops-tags
          if [[ "${{ needs.detect_changes.outputs.has_backend }}" == "true" ]]; then
            printf "manager=%s"  "${{ steps.tag.outputs.tag }}" > gitops-tags/manager.tag
            printf "worker=%s"   "${{ steps.tag.outputs.tag }}" > gitops-tags/worker.tag
          fi
          if [[ "${{ needs.detect_changes.outputs.has_frontend }}" == "true" ]]; then
          printf "frontend=%s" "${{ steps.tag.outputs.tag }}" > gitops-tags/frontend.tag
          fi

      - name: Upload GitOps tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitops-tags
          path: gitops-tags/

  update_gitops:
    needs: [detect_changes, build_and_publish]
    if: ${{ needs.build_and_publish.result == 'success' && (needs.detect_changes.outputs.has_backend == 'true' || needs.detect_changes.outputs.has_frontend == 'true') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: LerianStudio/midaz-firmino-gitops
          token: ${{ secrets.MANAGE_TOKEN }}
          path: gitops
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo curl -L https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Git pull before update
        run: |
          cd gitops
          git pull origin main

      - name: Download GitOps tag artifact
        uses: actions/download-artifact@v4
        with:
          name: gitops-tags
          path: .gitops-tags

      - name: Apply tags to values.yaml
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ env.IS_RC }}" == "true" ]]; then
            FILE="${{ env.GITOPS_FILE_STG }}"
          else
            FILE="${{ env.GITOPS_FILE_DEV }}"
          fi
          echo "Using values file: $FILE"

          upd() {
            local key="$1" file="$2"
            [[ -f "$file" ]] || return 0
            local TAG
            TAG="$(cut -d= -f2 < "$file" | tr -d '[:space:]')"
            [[ -n "$TAG" ]] || return 0
            TAG="$TAG" yq e -i "$key = strenv(TAG)" "$FILE"
            echo "Set $key â†’ $TAG"
          }

          # Imagens
          upd '.manager.image.tag'  .gitops-tags/manager.tag
          upd '.worker.image.tag'   .gitops-tags/worker.tag
          upd '.frontend.image.tag' .gitops-tags/frontend.tag

          # Configmaps do backend (se houver manager/worker)
          if [[ -f ".gitops-tags/manager.tag" ]]; then
            TAG="$(cut -d= -f2 < .gitops-tags/manager.tag | tr -d '[:space:]')"
            TAG="$TAG" yq e -i '.manager.configmap.VERSION = strenv(TAG)' "$FILE"
            TAG="$TAG" yq e -i '.manager.configmap.OTEL_RESOURCE_SERVICE_VERSION = strenv(TAG)' "$FILE"
            TAG="$TAG" yq e -i '.manager.configmap.SWAGGER_VERSION = strenv(TAG)' "$FILE"
          fi
          if [[ -f ".gitops-tags/worker.tag" ]]; then
            TAG="$(cut -d= -f2 < .gitops-tags/worker.tag | tr -d '[:space:]')"
            TAG="$TAG" yq e -i '.worker.configmap.VERSION = strenv(TAG)' "$FILE"
            TAG="$TAG" yq e -i '.worker.configmap.OTEL_RESOURCE_SERVICE_VERSION = strenv(TAG)' "$FILE"
          fi

      - name: Commit & push (GitOps)
        run: |
          set -e
          cd gitops
          git config user.name "${{ secrets.LERIAN_CI_CD_USER_NAME }}"
          git config user.email "${{ secrets.LERIAN_CI_CD_USER_EMAIL }}"
          git commit -am "ci(plugin-smart-templates): update image tags (${{ env.IS_RC == 'true' && 'rc/stg' || 'beta/dev' }})" || echo "No changes to commit"
          git push origin main

      - name: ArgoCD Sync
        uses: LerianStudio/github-actions-argocd-sync@main
        with:
          app-name: firmino-plugin-smart-templates
          argo-cd-token: ${{ secrets.ARGOCD_GHUSER_TOKEN }}
          argo-cd-url: ${{ secrets.ARGOCD_URL }}
          env-prefix: ${{ env.IS_RC == 'true' && 'stg' || env.IS_BETA == 'true' && 'dev' }}

  api-dog-e2e-tests:
    needs: update_gitops
    if: ${{ env.IS_BETA == 'true' || env.IS_RC == 'true' }}
    uses: LerianStudio/github-actions-shared-workflows/.github/workflows/api-dog-e2e-tests.yml@main
    with:
      node_version: '20'
      test_scenario_id: <plugin smart templates test scenario id>
      environment_id: ${{ env.IS_RC == 'true' && <plugin smart templates stg environment id> || env.IS_BETA == 'true' && <plugin smart templates dev environment id> }}
      test_iterations: '1'
      output_formats: 'html,cli'
      runner_type: 'firmino-lxc-runners'
    secrets:
      apidog_access_token: ${{ secrets.APIDOG_ACCESS_TOKEN }}